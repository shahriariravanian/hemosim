modeler.analyze=function(b){var e=this.scenario.loop;if(0==e.length)window.alert("No reentry loop is defined for this scenario");else{for(var c=300,d,f,a,g,l,h,k,n=0;50>n;n++){var m=0;for(f=d=0;f<e.length;f++)a=this.links[e[f]],g=a.from,l=a.erp,h=g.erp,k=c/a.scale-l,h=c/g.scale-h,l=evaluate(a.erp0,c/a.scale,k),h=evaluate(g.erp0,c/g.scale,h),k=evaluate(a.delay0,c/a.scale,k),m+=k*a.scale,d=Math.max(d,l*a.scale,k*a.scale,h*g.scale),a.erp=l,g.erp=h;c=.2*m+.8*c;if(.5>Math.abs(c-m))break}if(c>=d)if(b){controller.cardiovert();
b=viewer.tick-c;for(f=0;f<e.length;f++)g=a.from,g.t0=b,g.erp0&&(h=c/g.scale-g.erp,g.erp=evaluate(g.erp0,c/g.scale,h)),g.state=0,a=this.links[e[f]],a.t0=b,k=c/a.scale-a.erp,a.erp=evaluate(a.erp0,c/a.scale,k),a.delay=evaluate(a.delay0,c/a.scale,k),a.state=0,b+=a.delay;a.state=3;a.to.stim(viewer.tick,a.from)}else window.alert("Reentry is possible at a cycle length of "+Math.round(c)+"ms with the loop ERP of "+Math.round(d)+"ms");else window.alert("Reentry is not possible, the expected cycle length is "+
Math.round(c)+"ms and the loop ERP is "+Math.round(d)+"ms")}};modeler.detect_circuit=function(){function b(c){if(null!=c.path){var d=c,e="";do{var a=d.path;e=e+d.name+"("+a.name+")";d=a.forward?a.to:a.from}while(c!=d);e+=c.name;window.alert(e);return!0}for(d in c.out)if(a=c.out[d],9!=a.state)if(c.path=a,a.forward&&a.from==c){if(b(a.to))return!0}else if(!a.forward&&a.to==c&&b(a.from))return!0;c.path=null;return!1}for(var e in this.nodes)this.nodes[e].path=null;b(this.nodes.av)||b(this.nodes.rv)||window.alert("No reentry circuit found.")};
function Node(){this.t0=this.state=0;this.erp=200;this.cl=Math.MAX_VALUE;this.mean_cl=650;this.out=[];this.name="<>";this.paced=0;this.scale=1;this.cl0=this.erp0=this.path=null}
Node.prototype={constructor:Node,stim:function(b,e){if(0==this.state){var c=(b-this.t0)/this.scale-this.erp;this.erp=evaluate(this.erp0,(b-this.t0)/this.scale,c);this.mean_cl=.1*(b-this.t0)/this.scale+.9*this.mean_cl;this.cl=evaluate(this.cl0,this.mean_cl,c);this.update(b);intervals.update(this.name,b);this.t0=b;this.state=2;for(var d in this.out)this.out[d].stim(b,this);this.state=1}9==this.state||"@"!=e.name.charAt(0)&&"#"!=e.name.charAt(0)||(this.paced=b)},update:function(b){},run:function(b){0==
this.state&&b>=this.t0+this.cl?this.stim(b,this):1==this.state&&b>=this.t0+this.erp*this.scale&&(this.paced=this.state=0)},egm:function(b,e,c){var d=b-this.t0;return.02*Math.random()+(d>e?0:Math.sin(d*Math.PI/e)*(Math.abs(d/c-Math.floor(d/c+.5))-.25))+(this.paced?1/(b-this.paced+1):0)},reset:function(b){this.t0=b;this.state=0}};function create_node(b,e,c){var d=new Node;d.name=b;d.erp0=e;d.cl0=c;return d}function create_add_node(b,e,c){return modeler.nodes[b]=create_node(b,e,c)}
function Link(){this.t0=this.state=0;this.erp=200;this.delay=100;this.source=this.to=this.from=null;this.name="->";this.scale=1;this.forward=!1;this.delay0=this.erp0=null}
Link.prototype={constructor:Link,stim:function(b,e){if(0==this.state){this.source=e;this.forward=this.from==this.source;this.state=1;var c=(b-this.t0)/this.scale-this.erp;this.erp=evaluate(this.erp0,(b-this.t0)/this.scale,c);this.delay=evaluate(this.delay0,(b-this.t0)/this.scale,c);this.update(b);0>this.delay&&(this.state=3);this.t0=b}},update:function(b){},run:function(b){1==this.state&&b>=this.t0+this.delay*this.scale&&(this.state=2,this.from==this.source&&this.to.stim(b,this),this.to==this.source&&
this.from.stim(b,this),this.state=3);3==this.state&&b>=this.t0+this.erp*this.scale&&(this.state=0)},reset:function(b){this.t0=b;this.state=0}};function create_link(b,e,c,d,f,a){var g=new Link;g.from=e;g.to=c;e.out.push(g);d&&c.out.push(g);g.erp0=a;g.delay0=f;g.name=b;return g}function create_add_link(b,e,c,d,f,a){return modeler.links[b]=create_link(b,e,c,d,f,a)}
function evaluate(b,e,c){if(null==b)return Math.MAX_VALUE;if("number"==typeof b)return b;if(!$.isArray(b))return null;var d,f=0;if("string"!=typeof b[0]){for(d=0;d<b.length;d++)f+=evaluate(b[d],e);return f}var a=Array(b.length);for(d=1;d<b.length;d++)a[d]=evaluate(b[d],e);switch(b[0]){case "add":for(d=1;d<b.length;d++)f+=a[d];return f;case "tau":switch(d=a[1],b.length){case 2:return e<d?Math.MAX_VALUE:0;case 3:return e<d?Math.MAX_VALUE:a[2];case 4:return e<d?a[3]:a[3]*Math.exp(-(e-d)/a[2]);case 5:return a[4]+
(e<d?a[3]:a[3]*Math.exp(-(e-d)/a[2]));case 6:return e<d?a[3]+a[5]:a[3]*Math.exp(-(e-d)/a[2])+a[5]*Math.exp(-(e-d)/a[4]);case 7:return a[6]+(e<d?a[3]+a[5]:a[3]*Math.exp(-(e-d)/a[2])+a[5]*Math.exp(-(e-d)/a[4]))}case "tau*":switch(d=a[1],b.length){case 2:return c<d?Math.MAX_VALUE:0;case 3:return c<d?Math.MAX_VALUE:a[2];case 4:return c<d?a[3]:a[3]*Math.exp(-(c-d)/a[2]);case 5:return a[4]+(c<d?a[3]:a[3]*Math.exp(-(c-d)/a[2]));case 6:return c<d?a[3]+a[5]:a[3]*Math.exp(-(c-d)/a[2])+a[5]*Math.exp(-(c-d)/
a[4]);case 7:return a[6]+(c<d?a[3]+a[5]:a[3]*Math.exp(-(c-d)/a[2])+a[5]*Math.exp(-(c-d)/a[4]))}case "sel":switch(b.length){case 2:return a[1]*Math.random();case 3:return a[2]+a[1]*Math.random();case 4:return Math.random()<a[1]?a[2]:a[3]}}}function Intervals(){this.h1=this.h0=this.r2=this.r1=this.r0=this.a1=this.a0=this.p2=this.p1=this.p0=0}
Intervals.prototype={constructor:Intervals,update:function(b,e){("hra"==b||"ra1"==b)&&e-this.p0>viewer.margin?(this.p2=this.p1,this.p1=this.p0,this.p0=e):("sept"==b||"rv"==b||"lv"==b)&&e-this.r0>viewer.margin?(this.r2=this.r1,this.r1=this.r0,this.r0=e):"his"==b?(this.h1=this.h0,this.h0=e):"av"==b&&(this.a1=this.a0,this.a0=e)}};
var ecg_sig=[[0,.01,.02,.03,.04,.05,.06,.07,.08,.09,.1,.11,.12,.13,.14,.15,.16,.17,.18,.19,.2,.173,.147,.12,.093,.067,.04,.013,-.013,-.04,-.067,-.093,-.12,-.147,-.173,-.2,-.227,-.253,-.28,-.307,-.333,-.36,-.387,-.413,-.44,-.467,-.493,-.52,-.547,-.573,-.6,-.58,-.56,-.54,-.52,-.5,-.48,-.46,-.44,-.42,-.4,-.38,-.36,-.34,-.32,-.3,-.28,-.26,-.24,-.22,-.2,-.18,-.16,-.14,-.12,-.1,-.08,-.06,-.04,-.02,0,.02,.04,.06,.08,.1,.12,.14,.16,.18,.2,.22,.24,.26,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.52,.54,.56,
.58,.6,.58,.56,.54,.52,.5,.48,.46,.44,.42,.4,.38,.36,.34,.32,.3,.28,.26,.24,.22,.2,.18,.16,.14,.12,.1,.08,.06,.04,.02,0,0,0,0,0,0,0,0,0,0],[0,-.016,-.032,-.048,-.064,-.08,-.096,-.112,-.128,-.144,-.16,-.176,-.192,-.208,-.224,-.24,-.256,-.272,-.288,-.304,-.32,-.336,-.352,-.368,-.384,-.4,-.416,-.432,-.448,-.464,-.48,-.496,-.512,-.528,-.544,-.56,-.576,-.592,-.608,-.624,-.64,-.656,-.672,-.688,-.704,-.72,-.736,-.752,-.768,-.784,-.8,-.795,-.79,-.785,-.78,-.775,-.77,-.765,-.76,-.755,-.75,-.745,-.74,-.735,
-.73,-.725,-.72,-.715,-.71,-.705,-.7,-.705,-.71,-.715,-.72,-.725,-.73,-.735,-.74,-.745,-.75,-.755,-.76,-.765,-.77,-.775,-.78,-.785,-.79,-.795,-.8,-.784,-.768,-.752,-.736,-.72,-.704,-.688,-.672,-.656,-.64,-.624,-.608,-.592,-.576,-.56,-.544,-.528,-.512,-.496,-.48,-.464,-.448,-.432,-.416,-.4,-.384,-.368,-.352,-.336,-.32,-.304,-.288,-.272,-.256,-.24,-.224,-.208,-.192,-.176,-.16,-.144,-.128,-.112,-.096,-.08,-.064,-.048,-.032,-.016,0,0,0,0,0,0,0,0,0,0],[0,.014,.029,.043,.057,.071,.086,.1,.114,.129,.143,
.157,.171,.186,.2,.214,.229,.243,.257,.271,.286,.3,.314,.329,.343,.357,.371,.386,.4,.414,.429,.443,.457,.471,.486,.5,.514,.529,.543,.557,.571,.586,.6,.614,.629,.643,.657,.671,.686,.7,.714,.729,.743,.757,.771,.786,.8,.814,.829,.843,.857,.871,.886,.9,.914,.929,.943,.957,.971,.986,1,.98,.96,.94,.92,.9,.88,.86,.84,.82,.8,.78,.76,.74,.72,.7,.68,.66,.64,.62,.6,.58,.56,.54,.52,.5,.48,.46,.44,.42,.4,.38,.36,.34,.32,.3,.28,.26,.24,.22,.2,.18,.16,.14,.12,.1,.08,.06,.04,.02,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0]],ecg_len=[140,140,140],nchans=3;function Ecg(){this.state=0;this.ta=this.t0=-1;this.tt=[];for(var b=0;b<nchans;b++)this.tt[b]=-1;this.v1=0;this.erp=300;this.points=this.sum=0;this.dir=1}
Ecg.prototype={stim:function(b,e){if(0==this.state){for(var c=0;c<nchans;c++)this.tt[c]=-1;this.erp=(b-this.t0)/2;if(100>this.erp||400<this.erp)this.erp=200;this.tt[e]=this.t0=b;this.state=1;this.points=this.sum=0}else 1==this.state&&(this.tt[e]=b)},stim_atrium:function(b,e){this.ta=b;this.dir=e},run:function(b){this.v1=0;if(0!=this.state)if(2==this.state)b>=this.t0+this.erp&&(this.state=0);else{var e=[],c=[],d=0,f;for(f=0;f<nchans;f++)-1==this.tt[f]||b-this.tt[f]>=ecg_len[f]?e[f]=c[f]=0:(e[f]=ecg_sig[f][Math.round(b-
this.tt[f])],c[f]=(b-this.tt[f])/ecg_len[f],d+=c[f]);for(f=0;f<nchans;f++)1>c[f]&&(this.v1-=(1-d)/(1-c[f])*e[f]);1<=d&&(this.state=2);this.points++;this.sum+=this.v1}},egm:function(b,e,c){e=.05*Math.random();c=60>b-this.ta?this.dir*Math.sin((b-this.ta)*Math.PI/60)*.15:0;return 1==this.state?e-c+this.v1:2==this.state&&100>this.t0+this.erp-b?e-c-Math.sin((this.t0+this.erp-b)*Math.PI/100)*this.sum/this.points:e-c}};
